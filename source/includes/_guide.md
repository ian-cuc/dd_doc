# 接入指南钉钉开放平台提供了企业通讯录管理、文件管理、发送企业会话消息等功能，接口使用可以参考[服务端开发文档](http://open.dingtalk.com/#服务端开发文档)；我们定制了微应用专用的运行容器，提供了一组可以调用钉钉的原生控件和业务逻辑的JS接口，开发者可以通过这些接口使用钉钉中定制的原生控件或者复用钉钉原有的业务逻辑，降低开发成本，提高微应用在移动客户端的体验。接口使用可以参考[客户端开发文档](http://open.dingtalk.com/#客户端开发文档)。该指南主要介绍了企业和ISV如何接入钉钉开放平台，其中涉及到接入过程中使用的工具、与钉钉开放平台相关的概念和接入钉钉开放平台的一些实践方法，以帮助开发者快速开发自己的微应用。## 企业接入企业接入指南重点介绍使用钉钉开放平台的开发微应用的流程，帮助企业快速接入钉钉开放平台。该节主要分为四个部分：第一部分介绍企业接入钉钉开放平台的准备工作；第二部介绍如何访问开放平台服务端接口；第三部分介绍钉钉开放平台提供的员工身份验证流程；第四部分介绍发送消息到微应用会话。<br />### 开发环境准备开发者在使用钉钉开放平台开发微应用前需做好以下准备：- 获取钉钉开放平台开发者信息；- 服务端环境搭建和域名注册；- 开发环境搭建；开发者可以从 **[钉钉管理后台](https://oa.dingtalk.com)** 获取必要的信息用于微应用开发，还可以利用该系统完成微应用配置相关的工作；开发者可以自己搭建服务器也可以购买云主机来搭建自己的服务端环境，开发者需要为自己的微应用注册合法有效的域名并配置在 **[应用中心](https://oa.dingtalk.com/#/microApp/microAppList)** ；钉钉开放平台的服务端接口不区分语言和平台，开发者可以使用自己熟悉的技术搭建开发环境来开发微应用。**[钉钉管理后台](https://oa.dingtalk.com)** 系统为企业提供了企业通讯录管理、微应用、安全中心、员工数据统计和系统常用设置等功能。![oa_system.jpg](https://img.alicdn.com/tps/TB1rH0DIVXXXXadXXXXXXXXXXXX.jpg)**钉钉管理后台管理员（以下简称钉钉后台管理员）** 在企业通讯录管理页面可以完成企业的组织结构和员工个人信息的添加、删除、查看和修改等操作；在微应用管理页面可以完成添加和删除微应用，获取CorpID和CorpSecret(接入钉钉开放平台的凭证)，查看微应用相关信息，管理微应用的运行状态等。开发者在使用该系统前需要注册成为钉钉后台管理员或者由钉钉后台管理员分配管理员子帐号。#### 钉钉后台管理员注册:一、进入 **[钉钉管理后台](https://oa.dingtalk.com)** 页面, 点击 **[企业注册](https://oa.dingtalk.com/register.html?spm=0.0.0.0.dL51oc)**；![enterprise_register_entry](https://img.alicdn.com/tps/TB14kI8IFXXXXciapXXXXXXXXXX.jpg)二、填写注册手机号码和短信验证码；三、输入企业基本信息和管理员帐号和密码，点击 *注册* 按钮完成注册过程。![input_enterprise_info](https://img.alicdn.com/tps/TB1b74tIVXXXXXaXFXXXXXXXXXX.jpg)<aside class="notice">通过钉钉移动客户端创建的企业默认没有设置钉钉后台管理员，需要通过以上流程注册管理员帐号。</aside>#### 分配管理员子账号：一、登录钉钉后台管理系统，按下图进入安全中心的添加管理员子帐号页面；![add_sub_manager](https://img.alicdn.com/tps/TB1ItRLIVXXXXauXXXXXXXXXXXX.jpg)二、按下图提示填写子帐号信息![set_sub_manager_account](https://img.alicdn.com/tps/TB1S.JwIVXXXXcVXpXXXXXXXXXX.jpg)完成管理员子帐号设置后，子帐号关联的钉钉用户会在钉钉客户端的 *钉小秘* 会话中收到管理员帐号和初始密码，该钉钉用户可以通过收到的帐号和密码登录 **[钉钉管理后台](https://oa.dingtalk.com)** 进入安全中心对初始密码进行修改。#### 微应用管理登录钉钉管理后台后可以进入 *应用中心* 页面对微应用进行运行状态管理，进入微应用后台，微应用信息查看与设置，微应用添加和删除等操作。![enter_microapp_center](https://img.alicdn.com/tps/TB1jXVyIVXXXXaLXFXXXXXXXXXX.jpg)点击 *新增微应用* 按钮，按下图填写微应用信息，点击确定后可以新增微应用。![add_micro_app](https://img.alicdn.com/tps/TB19fVHIVXXXXbXXFXXXXXXXXXX.jpg)*首页地址* : 以`http://`或者`https://` 开头的URL，是微应用的首页地址；在移动设备上打开微应用Tab页，点击微应用列表中的微应用将访问这个URL指向的页面。*后台地址* : 以`http://`或者`https://` 开头的URL，是微应用的后台管理页面地址；配置后台地址后可以通过应用中心页面进入到微应用的管理后台。<aside class="notice"><b>首页地址</b> 的URL域名务必保证真实有效，否则会导致钉钉用户无法正常使用微应用。</aside>每个微应用都有 *设置* 选项，点击后进入微应用的设置页面，开发者可以在这里修改微应用的常用信息设置![get_micro_app_agentID](https://img.alicdn.com/tps/TB1sOhPIVXXXXcyXpXXXXXXXXXX.jpg)开发者在应用中心创建微应用后，如上图所示可获取到微应用的AgentID，AgentID可用于发送企业会话消息等场景。开发者完成以上准备工作后就可以进入开发阶段。<br />### 调用平台接口开发者在调用钉钉开放平台接口时需要附加AccessToken，AccessToken可以通过CorpID和CorpSecret获取。#### 获取CorpID和CorpSecretCorpID是企业的唯一标识，获取CorpID和CorpSecret的步骤如下:一、使用管理员帐号登录 **[钉钉管理后台](https://oa.dingtalk.com)** ；二、选择顶部菜单 **微应用** 进入微应用页面，在左侧菜单选择 **微应用设置** 进入微应用设置页；三、在微应用设置页面底部点击 **获取** 按钮即可获取CorpID和CorpSecret。![get_scecret_corpId](https://img.alicdn.com/tps/TB1k6hoIVXXXXcXapXXXXXXXXXX.jpg)<aside class="notice">钉钉开放平台提供了获取和修改企业(团队)的组织结构信息、人员信息等功能，所以请妥善保管CorpID和CorpSecret，避免外泄影响企业信息安全。</aside>#### 获取AccessToken开发者在调用开放平台接口前需要通过CorpID和CorpSecret获取AccessToken。获取AccessToken的方法是向 `https://oapi.dingtalk.com/gettoken?corpid=id&corpsecret=secrect` GET请求。开发者获取AccessToken后便可以调用开放平台其他接口。以获取部门列表接口为例，获取部门列表接口为：`oapi.dingtalk.com/department/list`在请求该接口时，需要将获取的AccessToken作为请求参数拼装到URL中：`https://oapi.dingtalk.com/department/list?access_token=ACCESS_TOKEN`更多关于AccessToken的信息请参考<a  href="http://open.dingtalk.com/#建立连接">《服务端开发文档-建立连接》</a>一节。<br />### 使用免登服务钉钉开放平台提供了身份验证接口，用于验证当前访问微应用用户的身份信息。用户在钉钉客户端使用微应用不需输入帐号和密码，提高微应用的使用体验与安全性。微应用免登过程如下图所示：![OAuth](https://img.alicdn.com/tps/TB12f4SIVXXXXXdaVXXXXXXXXXX.png)微应用的页面加载时需要进行用户身份验证，我们推荐开发者使用Cookie技术降低调用钉钉开放平台验证用户身份接口的次数避免不必要的加载页面的时间开销。1. 用户在钉钉客户端中发起访问微应用页面的请求（假设此微应用的首页地址为：https://www.abc.com/oa），浏览器会自动将与首页地址域名相关的Cookie附加在请求中一起发送到微应用服务器；2. 微应用服务器通过请求的Cookie判断用户身份，若成功判断用户身份且用户有权访问请求的页面则将页面内容返回并结束用户身份验证流程；否则，判断请求中是否有code和state参数，若无code和state参数进入第3步，否则进入第9步；3. 生成STATE码，STATE可以使用a-zA-Z0-9，长度不超过128个字节，建议开发者将STATE码使用Cookie或者Session的方式标记该次请求；4. 构造302响应，指定响应头的Location字段值为 `https://oapi.dingtalk.com/connect/oauth2/authorize?appid=CORPID&redirect_uri=https://www.abc.com/oa&response_type=code&scope=snsapi_base&state=STATE#ding_redirect` appid是企业的CorpID；redirect_uri是要重定向的链接地址，这里指向第1步访问微应用页面的地址，需要做URL编码处理；response_type与scope为定值分别为code和snsapi_base；state是第3步生成的STATE码；将构造好的响应消息返回给微应用Web容器；5. 微应用Web容器根据第4步的响应向Location字段标识的地址请求获取userID的授权码；6.  钉钉开发平台服务器验证微应用页面地址合法性以及当前进行请求的钉钉用户属于当前企业，如果不通过则返回错误提示页面并结束用户身份验证流程；否则，生成获取userID的授权码CODE；7. 构造302响应，响应头的Location字段值为https://www.abc.com/oa?code=CODE&state=STATE，code为第6步生成的临时授权码，state为第5步请求中URL的state参数值，将请求重定向到第1步用户在钉钉客户端中发起访问微应用页面；8. 用户在钉钉客户端中再次发起访问微应用页面的请求；9. 若此时微应用服务有AccessToken，则进入第11步，否则应当向钉钉开发平台请求AccessToken（获取方法参考[调用平台接口](http://open.dingtalk.com/#调用平台接口)）；10. 请求合法返回AccessToken，否则返回错误页面结束结束身份验证；11. 根据请求中的state判断这次请求的合法性，若为非法访问则返回错误页面，结束用户身份验证流程；否则向钉钉开放平台请求userID，构造的请求为 `https://oapi.dingtalk.com/user/getuserinfo?access_token=AccessToken&code=CODE`，access_token是第9步获取的AccessToken ；code是第7步生成的临时授权码；12. 根据AccessToken和CODE生成userID并返回；若AccessToken非法则进入第9步，若CODE非法则返回错误信息，微应用服务器根据错误信息重新处理或者结束身份验证流程；13. 微应用服务器获取userID根据内部业务逻辑判断是否可以允许用户访问该微应用页面；若允许则进入第14步，否则返回错误信息结束身份验证流程；14. 返回微应用页面；推荐开发者在这里设置Cookie用于避免该用户再次访问同一个页面时触发免登身份验证流程；将STATE做失效处理。详细文档请参阅[服务端开发文档 - 免登服务](http://open.dingtalk.com/#免登服务)。<aside class="notice">其中STATE要保证随机生成，尽量避免重复，并且推荐开发者使用以防止CSRF攻击。</aside><br />### 发送企业会话消息用户可以在企业会话中查看微应用发送的消息，开发者可以通过发送消息接口将消息发送到企业会话中。![send_micro_app_message](https://img.alicdn.com/tps/TB1LvU_IpXXXXa_XFXXXXXXXXXX.jpg)调用消息发送接口时需要使用`HTTPS`协议，发送的数据包为`JSON`格式。目前钉钉开放平台支持文本、图片、声音、文件、链接、办公消息等消息类型。### 示例程序在[《Open API - 代码示例》](http://open.dingtalk.com/#demo)的Java版本中有发送消息的代码演示，开发者可以下载参考。如果在使用开放平台中遇到困难请浏览[《Open API - 常见问题》](http://open.dingtalk.com/#faq)一节，若仍不能解决请按概述中的提供的反馈方式联系我们。## 合作伙伴接入### 钉钉ISV（服务提供商）应用授权和接口说明欢迎成为钉钉微应用的应用提供商！通过接入钉钉ISV的应用授权接口，可以快速发布自己的微应用套件，引导企业客户自动开通微应用，将自己的服务快速触达到自己的目标客户！钉钉的应用授权方案包含以下两个场景：#### 1.ISV注册应用你，作为ISV若要使用此方案，只需注册成为第三方应用提供商（前期请直接联系钉钉运营人员或发邮件申请成为ISV开发者），在ISV接入后台创建应用套件，并在应用套件中配置好相应的应用。本方案所说的应用套件，是第三方应用授权的主体，它可以包含多个第三方所提供的同一类型的应用。目前一个第三方最多可以注册五个应用套件，一个应用套件最多可以包含五个应用。#### 2.企业管理员授权应用企业的管理员在钉钉企业后台的微应用列表中浏览你的应用套件后，即可发起一键授权，系统将展示微应用的第三方授权页面，管理员根据授权页面的引导，确认授权内容，完成授权操作。授权完成之后，企业就可使用ISV应用提供商所提供的应用服务了。一切将变得简单自然。以下是详细的接口调用时序图![Mou icon](https://img.alicdn.com/tps/TB1jWcaIFXXXXa5XpXXXXXXXXXX.png)### 1:注册成为第三方应用提供商需要提供的数据项：信息项		| 要求及说明-----------	| -------------企业Logo		| 应用提供商的企业Logo，小于2M，640*240，背景为白色企业简称		| 使用对外宣传的企业简称，能代表企业的名字，2-16个字企业简介 		| 描述企业所提供的服务，4-120个字企业官网 		| 应用服务商的企业官网### 2:创建应用套件和微应用需要提供的数据项：信息项			| 要求及说明-----------		| -------------服务事件接收URL	| 系统将会把此套件的授权变更事件以及ticket参数推送给此URL。(ticket说明详见API接口说明)Token			| 可任意填写，用于生成签名,校验回调请求的合法性。后续所有托管的企业产生的回调消息都使用该值来解密。EncodingAESKey 	| 回调消息加解密参数，是AES密钥的Base64编码，用于解密回调消息内容对应的密文。后续所有托管的企业产生的回调消息都使用该值来解密。白名单IP列表 		| 应用套件调用第三方应用API时的合法IP列表，只有白名单内的IP才能正常调用API，后续IP若有修改，需要及时进行列表更新。套件logo图片| png格式套件介绍网站 | 128字符以内套件描述 | 120字符以内套件试用行业 | 16字符以内套件关键词标签 | 16字符以内创建应用的基本信息：信息项	| 要求及说明-------	| -------------应用Logo	|应用的Logo，小于2M，640*240，在授权页会被用于展示。应用名称	|应用的名称，2-16个字。功能介绍	|描述该应用的功能与特色，4-120个字内开发信息：应用参数内容	| 要求及说明-------	| -------------callbackurl|用于接收托管企业应用的用户消息，URL支持使用$CORPID$模板参数表示corpid，推送事件时会替换为企业的corpid。特殊权限	|应用的特殊权限为上报地理位置的功能开关，若在创建应用时勾选了此特殊权限，在授权会提示用户。### 3: 回调接口（分为三个回调类型）https://127.0.0.1/suite/receive?msg_signature=3a7b08bb8e6dbce3c9671d6fdb69d15066227608&timestamp=1403610513&nonce=380320359#### a: 定时推送Ticket服务器会向应用提供商申请时填写的套件事件接收 URL定时（二十分钟）推送ticket：POST数据示例```{  "SuiteKey": "dingxxxxxx",  "EventType": "suite_ticket ",  "TimeStamp": 1234456,  "SuiteTicket": "adsadsad",}```应用提供商在收到ticket推送后需要返回字符串success。参数			| 说明-------		| -------------SuiteKey	| 应用套件的SuiteKeyInfoType	| suite_ticketTimeStamp	| 时间戳SuiteTicket	| Ticket内容#### b:回调向ISV推送临时授权码当授权方（即授权企业）在微应用管理端的授权管理中，向应用提供商的应用套件授权了访问权限，钉钉服务器会向应用提供商的套件事件接收 URL（创建套件时填写）推送临时授权码POST数据示例```{  "SuiteKey": "dingxxxxxx",  "EventType": " tmp_auth_code",  "TimeStamp": 1234456,  "AuthCode": "adads",}```应用提供商在收到推送消息后需要返回字符串success字段说明参数			| 说明-------		| -------------SuiteKey	| 应用套件的SuiteKeyEventType	| change_authTimeStamp	| 时间戳AuthCode	| 临时授权码#### c:回调向ISV通知授权设置变更当授权方（即授权企业）在微应用管理端的授权管理中，修改了对套件方的授权托管后，钉钉服务器会向应用提供商的套件事件接收 URL（创建套件时填写）推送变更授权通知。POST数据示例```{  "SuiteKey": "dingxxxxxx",  "EventType": " change_auth",  "TimeStamp": 1234456,  "AuthCorpId": "xxxxx"}```应用提供商在收到推送消息后需要返回字符串success字段说明参数			| 说明-------		| -------------SuiteKey	| 应用套件的SuiteKeyEventType	| change_authTimeStamp	| 时间戳AuthCorpID	| 授权方企业的corpid### 4: 获取套件访问Token（suite_access_token）该API用于获取应用套件令牌（suite_access_token）接口调用请求说明https请求方式: POSThttps://oapi.dingtalk.com/service/get_suite_tokenPOST数据示例```{	"suite_key":"key_value", 	"suite_secret": "secret_value",	"suite_ticket": "ticket_value"}```请求参数说明参数				| 说明-------			| -------------suite_key		| 应用套件的keysuite_secret	| 应用套件secretsuite_ticket	| 钉钉后台推送的ticket返回结果示例```{	"suite_access_token":"61W3mEpU66027wgNZ_MhGHNQDHnFATkDa9-2llqrMBjUwxRSNPbVsMmyD-yq8wZETSoE5NQgecigDrSHkPtIYA", 	"expires_in":7200}```结果参数说明参数		| 说明-------	| -------------suite_access_token	| 应用套件access_tokenexpires_in			| 有效期### 5: 获取企业的永久授权码该API用于使用临时授权码换取授权方的永久授权码，并换取授权信息、企业access_token。注：临时授权码使用一次后即失效接口调用请求说明https请求方式: POSThttps://oapi.dingtalk.com/service/get_permanent_code?suite_access_token=xxxxPOST数据示例```{	"tmp_auth_code": " value"}```请求参数说明参数		| 说明-------	| -------------tmp_auth_cod | 回调接口（tmp_auth_code）获取的临时授权码返回结果示例```{	"permanent_code": "xxxx",	"auth_corp_info":	{		"corpid": "xxxx",		"corp_name": "name",    }}```结果参数说明参数		| 说明-------	| -------------permanent_code | 永久授权码corp_info | 授权方企业信息corpid | 授权方企业idcorp_name | 授权方企业名称### 6:获取企业授权的access_token应用提供商在取得企业的永久授权码并完成对企业应用的设置之后，便可以开始通过调用企业接口来运营这些应用。其中，调用企业接口所需的access_token获取方法如下。接口调用请求说明https请求方式: POSThttps://oapi.dingtalk.com/service/get_corp_token?suite_access_token=xxxxPOST数据示例```{	"auth_corpid": "auth_corpid_value",	"permanent_code": "code_value"}```请求参数说明参数		| 说明-------	| -------------auth_corpid	| 授权方corpidpermanent_code | 永久授权码，通过get_permanent_code获取返回结果示例```{	"access_token": "xxxxxx",	"expires_in": 7200}```结果参数说明参数 | 说明-------	| -------------access_token | 授权方（企业）access_tokenexpires_in | 授权方（企业）access_token超时时间### 7:获取企业授权的授权数据该API用于通过永久授权码换取授权信息。 永久code的获取，是通过临时授权码使用get_permanent_code 接口获取到的permanent_code。接口调用请求说明https请求方式: POSThttps://oapi.dingtalk.com/service/get_auth_info?suite_access_token=xxxxPOST数据示例```{	"auth_corpid":"auth_corpid_value",	"permanent_code":"code_value",	"suite_id":"id_value"}```请求参数说明参数					| 说明-------				| -------------suite_id			| 应用套件idauth_corpid			| 授权方corpidpermanent_code		| 永久授权码，通过get_permanent_code获取返回结果示例```{   "auth_corp_info":{	  "corp_logo_url":"http://xxxx.png",	  "corp_name":"corpid",	  "corpid":"auth_corpid_value"	},    "auth_info":{	"agent":[{			"agent_name":"aaaa",			"agentid":1,			"appid":-3,			"logo_url":"http://aaaaaa.com"	}	,{			"agent_name":"bbbb",			"agentid":4,			"appid":-2,			"logo_url":"http://vvvvvv.com"	}]	},		  "errcode":0,		  "errmsg":"ok"}```结果参数说明参数					| 说明-------				| -------------auth_corp_info		| 授权方企业信息corpid				| 授权方企业idcorp_name			| 授权方企业名称corp_logo_url		| 企业logoauth_info			| 授权信息agent				| 授权的应用信息agentid				| 授权方应用idagent_name			| 授权方应用名字logo_url			| 授权方应用头像appid				| 服务商套件中的对应应用id### 8:获取企业的应用信息该API用于获取授权方的企业的某个应用的基本信息，包括LOGO,名称，描述等,信息接口调用请求说明https请求方式: POSThttps://oapi.dingtalk.com/service/get_agent?suite_access_token=xxxxPOST数据示例```{	"agentid":541,	"auth_corpid":"auth_corpid_value",	"permanent_code":"code_value",	"suite_id":"id_value"}```请求参数说明参数					| 说明-------				| -------------suite_id			| 应用套件idauth_corpid			| 授权方corpidpermanent_code		| 永久授权码，从get_permanent_code接口中获取agentid				| 授权方应用id返回结果示例```{	"agentid":541,	"close":1,	"description":"企业重要消息",	"errcode":0,	"errmsg":"ok",	"logo_url":"http://xxxxxxx/png",	"name":"公告"}```结果参数说明参数			| 说明-------		| -------------agentid		| 授权方企业应用idname		| 授权方企业应用名称logo_url	| 授权方企业应用头像description	| 授权方企业应用详情close		| 授权方企业应用是否被禁用### 9:激活授权套件该API用于激活授权方企业的套件微应用,信息接口调用请求说明https请求方式: POSThttps://oapi.dingtalk.com/service/activate_suite?suite_access_token=xxxxPOST数据示例```{	"auth_corpid":"auth_corpid_value",	"suite_id":"id_value",	"permanent_code":"permanent_code"}```请求参数说明参数				| 说明-------			| -------------suite_id		| 应用套件idauth_corpid		| 授权方corpidpermanent_code	| 永久授权码，从get_permanent_code接口中获取返回结果示例```{	"errcode":0,	"errmsg":"ok"}```### 10: 加解密方案开启回调模式时，有以下术语需要了解：1. msg_signature是签名，用于验证调用者的合法性。具体算法见以下'消息体签名'章节2. EncodingAESKey用于消息体的加密，长度固定为43个字符，从a-z, A-Z, 0-9共62个字符中选取，是AESKey的Base64编码。解码后即为32字节长的AESKey3. AESKey=Base64_Decode(EncodingAESKey + “=”)，是AES算法的密钥，长度为32字节。AES采用CBC模式，数据采用PKCS#7填充；IV初始向量大小为16字节，取AESKey前16字节。具体详见：http://tools.ietf.org/html/rfc23154. msg为消息体明文，格式为XML5. msg_encrypt = Base64_Encode( AES_Encrypt[random(16B) + msg_len(4B) + msg + $CorpID] )，是对明文消息msg加密处理后的Base64编码。其中random为16字节的随机字符串；msg_len为4字节的msg长度，网络字节序；msg为消息体明文；$CorpID为isv的标识### 消息体签名为了验证调用者的合法性，钉钉在回调url中增加了消息签名，以参数msg_signature标识，企业需要验证此参数的正确性后再解密。验证步骤：1.  企业计算签名：dev_msg_signature=sha1(sort(token、timestamp、nonce、msg_encrypt))。sort的含义是将参数按照字母字典排序，然后从小到大拼接成一个字符串2. 比较dev_msg_signature和msg_signature是否相等，相等则表示验证通过在被动响应消息时，企业同样需要用如上方法生成签名并传给钉钉##### 加解密方案说明######	对明文msg加密的过程如下：msg_encrypt = Base64_Encode( AES_Encrypt[random(16B) + msg_len(4B) + msg + $CorpID] )AES加密的buf由16个字节的随机字符串、4个字节的msg长度、明文msg和$CorpID组成。其中msg_len为msg的字节数，网络字节序；$CorpID为isv的CorpID。经AESKey加密后，再进行Base64编码，即获得密文msg_encrypt。##### 对应于加密方案，解密方案如下：* 对密文BASE64解码：aes_msg=Base64_Decode(msg_encrypt)* 使用AESKey做AES解密：rand_msg=AES_Decrypt(aes_msg)* 验证解密后$CorpID、msg_len* 去掉rand_msg头部的16个随机字节，4个字节的msg_len,和尾部的$CorpID即为最终的消息体原文msg